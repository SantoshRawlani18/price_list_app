<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Price List App</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { background:#f6f7fb; }
  .hidden { display:none; }
</style>
</head>

<body>

<!-- ðŸ” PIN SCREEN -->
<div class="container mt-5" id="pinScreen">
  <div class="row justify-content-center">
    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-body">
          <h4 class="text-center mb-3">Enter PIN</h4>
          <input type="password" id="pinInput" class="form-control mb-2" placeholder="Enter PIN">
          <button class="btn btn-primary w-100" onclick="checkPin()">Unlock</button>
          <div id="pinError" class="text-danger text-center mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”“ MAIN APP -->
<div class="container hidden" id="appContent">

  <h3 class="text-center mt-3 mb-3">MAP Price List</h3>

  <!-- ITEM FORM -->
  <form id="addItemForm" class="row g-2">
    <div class="col-md-4">
      <input type="text" id="itemName" class="form-control" placeholder="Item Name" required>
    </div>

    <div class="col-md-3">
      <!-- âœ… VENDOR DROPDOWN -->
      <select id="vendorName" class="form-select" required>
        <option value="">Select Vendor</option>
      </select>
    </div>

    <div class="col-md-3">
      <input type="number" id="itemPrice" step="0.01" class="form-control" placeholder="Price â‚¹" required>
    </div>

    <div class="col-md-2">
      <button class="btn btn-success w-100">Add / Update</button>
    </div>
  </form>

  <!-- SEARCH -->
  <input type="text" id="searchBox" class="form-control mt-3"
         placeholder="Search item or vendor to see prices">

  <!-- TABLE -->
  <div class="table-responsive mt-3">
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Item</th>
          <th>Vendor</th>
          <th>Price (â‚¹)</th>
          <th>Last Updated</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="4" class="text-center text-muted">
            Type in search to see results
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- MANAGE VENDORS -->
  <button class="btn btn-outline-secondary w-100 my-3" onclick="toggleVendors()">
    Manage Vendors
  </button>

  <div id="vendorSection" class="card p-3 mb-4 d-none">
    <h5>Vendor Management</h5>
    <div class="row g-2 mt-2">
      <div class="col-md-6">
        <input type="text" id="newVendor" class="form-control" placeholder="New Vendor">
        <button class="btn btn-primary w-100 mt-1" id="addVendorBtn">Add Vendor</button>
      </div>
      <div class="col-md-6">
        <input type="text" id="oldVendor" class="form-control" placeholder="Old Vendor">
        <input type="text" id="renameVendor" class="form-control mt-1" placeholder="New Vendor Name">
        <button class="btn btn-warning w-100 mt-1" id="renameVendorBtn">Rename Vendor</button>
      </div>
    </div>
  </div>

</div>

<script>
/* CONFIG */
const APP_PIN = "1711"; // CHANGE PIN
const API_URL = "https://script.google.com/macros/s/AKfycbytrvtOXfZOMUxzRLNuWv-hllF4pTo7jolWd0rEtV-UMO_UY6jaGJMR2YR5i8eI6L8XLg/exec"; // CHANGE API URL


let data = [];
let vendors = [];

/* PIN */
function checkPin() {
  if (pinInput.value === APP_PIN) {
    sessionStorage.setItem("auth","yes");
    pinScreen.classList.add("hidden");
    appContent.classList.remove("hidden");
    loadData();
  } else pinError.innerText = "Wrong PIN";
}

if (sessionStorage.getItem("auth")==="yes") {
  pinScreen.classList.add("hidden");
  appContent.classList.remove("hidden");
  loadData();
}

/* TOGGLE VENDOR */
function toggleVendors() {
  vendorSection.classList.toggle("d-none");
}

/* LOAD DATA */
async function loadData() {
  const res = await fetch(API_URL);
  data = await res.json();
  extractVendors();
}

/* EXTRACT VENDORS */
function extractVendors() {
  vendors = new Set();
  data.forEach(d => {
    Object.keys(d.prices).forEach(v => vendors.add(v));
  });

  vendorName.innerHTML = `<option value="">Select Vendor</option>`;
  [...vendors].sort().forEach(v => {
    vendorName.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

/* RENDER TABLE */
function renderTable(arr) {
  if (!arr.length) {
    tableBody.innerHTML =
      `<tr><td colspan="4" class="text-center text-muted">No results found</td></tr>`;
    return;
  }

  tableBody.innerHTML="";
  arr.forEach(r=>{
    for (const v in r.prices) {
      tableBody.innerHTML+=`
        <tr>
          <td>${r.item}</td>
          <td>${v}</td>
          <td>â‚¹ ${r.prices[v]}</td>
          <td>${new Date().toLocaleString()}</td>
        </tr>`;
    }
  });
}

/* ADD / UPDATE PRICE */
addItemForm.onsubmit = async e => {
  e.preventDefault();
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"price",
      item:itemName.value.trim(),
      vendor:vendorName.value,
      price:parseFloat(itemPrice.value)
    })
  });
  addItemForm.reset();
  loadData();
};

/* SEARCH */
searchBox.oninput = () => {
  const q = searchBox.value.trim().toLowerCase();
  if (!q) {
    tableBody.innerHTML =
      `<tr><td colspan="4" class="text-center text-muted">
        Type in search to see results
      </td></tr>`;
    return;
  }

  const filtered = data.filter(d =>
    d.item.toLowerCase().includes(q) ||
    Object.keys(d.prices).some(v => v.toLowerCase().includes(q))
  );

  renderTable(filtered);
};

/* ADD / RENAME VENDOR */
addVendorBtn.onclick = async () => {
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"addVendor", vendor:newVendor.value.toUpperCase() })
  });
  newVendor.value="";
  loadData();
};

renameVendorBtn.onclick = async () => {
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"renameVendor",
      oldVendor:oldVendor.value.toUpperCase(),
      newVendor:renameVendor.value.toUpperCase()
    })
  });
  oldVendor.value="";
  renameVendor.value="";
  loadData();
};
</script>

</body>
</html>




